<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veil Hospital</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .table-wrap { overflow:auto; margin-top:14px; border-radius:14px; border:1px solid rgba(31,41,55,.9); background: rgba(11,18,32,.55); }
        table { width:100%; border-collapse:collapse; }
        thead th { text-align:left; font-size:12px; color:#9ca3af; padding:10px 12px; background: rgba(11,18,32,.8); border-bottom:1px solid rgba(31,41,55,.9); }
        tbody td { padding:10px 12px; border-bottom:1px solid rgba(31,41,55,.65); color:#e5e7eb; }
        .row-actions { display:flex; gap:8px; justify-content:flex-end; }
        .btn-ghost { background: rgba(17,24,39,.85); border:1px solid rgba(31,41,55,.9); }
        .btn-ghost:hover { filter:brightness(1.08); }
        .modal-bg { position:fixed; inset:0; background: rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:16px; }
        .modal { width:min(560px, 100%); background: rgba(17,24,39,.98); border:1px solid rgba(31,41,55,.95); border-radius:16px; padding:16px; box-shadow: 0 18px 50px rgba(0,0,0,.4); }
        .modal h2 { margin:0 0 12px 0; }
        .field { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
        .field label { color:#9ca3af; font-size:12px; }
        .field input { padding:10px 12px; border-radius:12px; border:1px solid rgba(31,41,55,.9); background: rgba(11,18,32,.7); color:#e5e7eb; outline:none; }
        .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }
        .msg { color:#f59e0b; font-size:13px; margin-top:8px; display:none; }
        .small { color:#9ca3af; font-size:12px; }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="logo">üè• Veil Hospital</div>

        <a href="/patients" class="nav-btn {% if view != 'discharged' %}active{% endif %}">Patients</a>
        <a href="/discharged" class="nav-btn {% if view == 'discharged' %}active{% endif %}">Discharged</a>
        <a href="/organs" class="nav-btn">üõ°Ô∏è Security</a>
        <a href="/status" class="nav-btn">System Status</a>

        <a href="/security-ui" class="nav-btn">üîí Security UI</a>
        <a href="/app/" class="nav-btn">üß† 3D Dashboard</a>
    </nav>

    <main>
        <header>
            <h1>{% if view == 'discharged' %}Discharged{% else %}Active{% endif %} Patients</h1>
            <button class="btn-primary" onclick="openModal()">+ New Patient</button>
        </header>

        <div class="stats">
            <div class="stat">
                <div class="stat-num">{{ counts.total }}</div>
                <div class="stat-label">Total Patients</div>
            </div>
            <div class="stat">
                <div class="stat-num">{{ counts.active }}</div>
                <div class="stat-label">Active</div>
            </div>
            <div class="stat">
                <div class="stat-num">{{ counts.discharged }}</div>
                <div class="stat-label">Discharged</div>
            </div>
        </div>

        <div class="tier-section">
            <h2 class="tier-title p2">Patient List</h2>

            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th style="width:80px;">ID</th>
                            <th>Name</th>
                            <th style="width:80px;">Age</th>
                            <th>Reason</th>
                            <th style="width:170px;">Admitted</th>
                            <th style="width:170px;">Discharged</th>
                            <th style="width:220px; text-align:right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in patients %}
                        <tr>
                            <td>#{{ p.id }}</td>
                            <td>{{ p.name }}</td>
                            <td>{{ p.age }}</td>
                            <td>{{ p.reason }}</td>
                            <td>{{ p.admitted_at }}</td>
                            <td>{{ p.discharged_at if p.discharged_at else "‚Äî" }}</td>
                            <td>
                                <div class="row-actions">
                                    {% if view == 'discharged' %}
                                        <button class="btn-sm btn-ghost" onclick="restorePatient({{ p.id }})">‚Ü© Restore</button>
                                    {% else %}
                                        <button class="btn-sm btn-stop" onclick="dischargePatient({{ p.id }})">‚ü≤ Discharge</button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}

                        {% if patients|length == 0 %}
                        <tr>
                            <td colspan="7" class="small">No patients in this view.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal-bg" id="modal-bg" onclick="closeModal(event)">
            <div class="modal" onclick="event.stopPropagation()">
                <h2>New Patient</h2>

                <div class="field">
                    <label>Name</label>
                    <input id="p-name" placeholder="e.g. Jordan Lee" />
                </div>

                <div class="field">
                    <label>Age</label>
                    <input id="p-age" type="number" placeholder="e.g. 41" />
                </div>

                <div class="field">
                    <label>Reason</label>
                    <input id="p-reason" placeholder="e.g. Observation / Check-up" />
                </div>

                <div class="msg" id="p-msg"></div>

                <div class="modal-actions">
                    <button class="btn-sm btn-ghost" onclick="closeModal()">Cancel</button>
                    <button class="btn-sm btn-start" onclick="createPatient()">Save</button>
                </div>
            </div>
        </div>

        <script>
            function openModal() {
                document.getElementById("p-msg").style.display = "none";
                document.getElementById("modal-bg").style.display = "flex";
            }
            function closeModal(e) {
                document.getElementById("modal-bg").style.display = "none";
            }
            function showMsg(t) {
                const el = document.getElementById("p-msg");
                el.textContent = t;
                el.style.display = "block";
            }

            async function createPatient() {
                const name = document.getElementById("p-name").value.trim();
                const age = document.getElementById("p-age").value;
                const reason = document.getElementById("p-reason").value.trim();

                try {
                    const res = await fetch("/api/patients", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({ name, age, reason })
                    });
                    const data = await res.json();
                    if (!res.ok || !data.ok) {
                        showMsg(data.error || "Failed");
                        return;
                    }
                    location.reload();
                } catch {
                    showMsg("Network error");
                }
            }

            async function dischargePatient(id) {
                await fetch(`/api/patients/${id}/discharge`, { method: "POST" });
                location.reload();
            }

            async function restorePatient(id) {
                await fetch(`/api/patients/${id}/restore`, { method: "POST" });
                location.reload();
            }
        </script>
    </main>
</body>
</html>
