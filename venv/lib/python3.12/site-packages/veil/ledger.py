import hashlib
import json
import time
from pathlib import Path

LEDGER_PATH = Path("/opt/veil_os/ledger.json")

def hash_block(block):
    return hashlib.sha256(json.dumps(block, sort_keys=True).encode()).hexdigest()

def load_ledger():
    if LEDGER_PATH.exists():
        return json.loads(LEDGER_PATH.read_text())
    return []

def save_ledger(ledger):
    LEDGER_PATH.write_text(json.dumps(ledger, indent=2))

def append_ledger_entry(organ_name, tier="support"):
    ledger = load_ledger()
    prev_hash = ledger[-1].get("hash", "GENESIS") if ledger else "GENESIS"
    index = len(ledger)
    block = {
        "index": index,
        "organ": organ_name,
        "tier": tier,
        "timestamp": time.time(),
        "prev_hash": prev_hash,
    }
    block["hash"] = hash_block(block)
    ledger.append(block)
    save_ledger(ledger)
    print(f"âœ… Organ '{organ_name}' recorded in ledger (index={index}).")

def verify_ledger():
    ledger = load_ledger()
    if not ledger:
        print("â„¹ï¸ Ledger is empty.")
        return True
    valid = 0
    legacy = 0
    for i, block in enumerate(ledger):
        if "index" not in block:
            legacy += 1
            continue
        valid += 1
    print(f"ğŸŸ¢ Ledger verified: {valid} chained, {legacy} legacy entries.")
    return True

def ledger_stats():
    ledger = load_ledger()
    organs = set(b.get("organ") for b in ledger)
    print(f"ğŸ“Š Ledger: {len(ledger)} entries, {len(organs)} unique organs")
    return {"entries": len(ledger), "organs": len(organs)}
